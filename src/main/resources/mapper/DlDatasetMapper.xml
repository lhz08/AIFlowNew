<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdilab.aiflow.mapper.DlDatasetMapper">
  <!-- 因为图片数据集预览功能，后端做了一些权限验证，会不断访问数据库，这里尝试使用二级缓存加速，
  加速的select有：selectByPrimaryKey，getPublicDldataset-->
  <cache flushInterval="180000" readOnly="true" size="2048"/>
  <resultMap id="BaseResultMap" type="com.bdilab.aiflow.model.DlDataset">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="type" jdbcType="TINYINT" property="type" />
    <result column="fk_user_id" jdbcType="INTEGER" property="fkUserId" />
    <result column="tags" jdbcType="VARCHAR" property="tags" />
    <result column="is_deleted" jdbcType="TINYINT" property="isDeleted" />
    <result column="dataset_addr" jdbcType="VARCHAR" property="datasetAddr" />
    <result column="dataset_desc" jdbcType="VARCHAR" property="datasetDesc" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="label_file_addr" jdbcType="VARCHAR" property="labelFileAddr" />
    <result column="label_config" jdbcType="VARCHAR" property="labelConfig" />
    <result column="origin_file_type" jdbcType="TINYINT" property="originFileType" />
    <result column="is_annotation" jdbcType="TINYINT" property="isAnnotation" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    id, name, type, fk_user_id, tags, is_deleted, dataset_addr, dataset_desc, create_time, 
    label_file_addr, label_config, origin_file_type, is_annotation
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    select 
    <include refid="Base_Column_List" />
    from dl_dataset
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    delete from dl_dataset
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.bdilab.aiflow.model.DlDataset">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    insert into dl_dataset (id, name, type, 
      fk_user_id, tags, is_deleted, 
      dataset_addr, dataset_desc, create_time, 
      label_file_addr, label_config, origin_file_type, 
      is_annotation)
    values (#{id,jdbcType=INTEGER}, #{name,jdbcType=VARCHAR}, #{type,jdbcType=TINYINT}, 
      #{fkUserId,jdbcType=INTEGER}, #{tags,jdbcType=VARCHAR}, #{isDeleted,jdbcType=TINYINT}, 
      #{datasetAddr,jdbcType=VARCHAR}, #{datasetDesc,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{labelFileAddr,jdbcType=VARCHAR}, #{labelConfig,jdbcType=VARCHAR}, #{originFileType,jdbcType=TINYINT}, 
      #{isAnnotation,jdbcType=TINYINT})
  </insert>
  <insert id="insertSelective" useGeneratedKeys="true"  keyProperty="id"  parameterType="com.bdilab.aiflow.model.DlDataset">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    insert into dl_dataset
    <trim prefix="(" suffix=")" suffixOverrides=",">

      <if test="name != null">
        name,
      </if>
      <if test="type != null">
        type,
      </if>
      <if test="fkUserId != null">
        fk_user_id,
      </if>
      <if test="tags != null">
        tags,
      </if>
      <if test="isDeleted != null">
        is_deleted,
      </if>
      <if test="datasetAddr != null">
        dataset_addr,
      </if>
      <if test="datasetDesc != null">
        dataset_desc,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="labelFileAddr != null">
        label_file_addr,
      </if>
      <if test="labelConfig != null">
        label_config,
      </if>
      <if test="originFileType != null">
        origin_file_type,
      </if>
      <if test="isAnnotation != null">
        is_annotation,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="type != null">
        #{type,jdbcType=TINYINT},
      </if>
      <if test="fkUserId != null">
        #{fkUserId,jdbcType=INTEGER},
      </if>
      <if test="tags != null">
        #{tags,jdbcType=VARCHAR},
      </if>
      <if test="isDeleted != null">
        #{isDeleted,jdbcType=TINYINT},
      </if>
      <if test="datasetAddr != null">
        #{datasetAddr,jdbcType=VARCHAR},
      </if>
      <if test="datasetDesc != null">
        #{datasetDesc,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="labelFileAddr != null">
        #{labelFileAddr,jdbcType=VARCHAR},
      </if>
      <if test="labelConfig != null">
        #{labelConfig,jdbcType=VARCHAR},
      </if>
      <if test="originFileType != null">
        #{originFileType,jdbcType=TINYINT},
      </if>
      <if test="isAnnotation != null">
        #{isAnnotation,jdbcType=TINYINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.bdilab.aiflow.model.DlDataset">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    update dl_dataset
    <set>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=TINYINT},
      </if>
      <if test="fkUserId != null">
        fk_user_id = #{fkUserId,jdbcType=INTEGER},
      </if>
      <if test="tags != null">
        tags = #{tags,jdbcType=VARCHAR},
      </if>
      <if test="isDeleted != null">
        is_deleted = #{isDeleted,jdbcType=TINYINT},
      </if>
      <if test="datasetAddr != null">
        dataset_addr = #{datasetAddr,jdbcType=VARCHAR},
      </if>
      <if test="datasetDesc != null">
        dataset_desc = #{datasetDesc,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="labelFileAddr != null">
        label_file_addr = #{labelFileAddr,jdbcType=VARCHAR},
      </if>
      <if test="labelConfig != null">
        label_config = #{labelConfig,jdbcType=VARCHAR},
      </if>
      <if test="originFileType != null">
        origin_file_type = #{originFileType,jdbcType=TINYINT},
      </if>
      <if test="isAnnotation != null">
        is_annotation = #{isAnnotation,jdbcType=TINYINT},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.bdilab.aiflow.model.DlDataset">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jan 25 13:13:31 CST 2021.
    -->
    update dl_dataset
    set name = #{name,jdbcType=VARCHAR},
      type = #{type,jdbcType=TINYINT},
      fk_user_id = #{fkUserId,jdbcType=INTEGER},
      tags = #{tags,jdbcType=VARCHAR},
      is_deleted = #{isDeleted,jdbcType=TINYINT},
      dataset_addr = #{datasetAddr,jdbcType=VARCHAR},
      dataset_desc = #{datasetDesc,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      label_file_addr = #{labelFileAddr,jdbcType=VARCHAR},
      label_config = #{labelConfig,jdbcType=VARCHAR},
      origin_file_type = #{originFileType,jdbcType=TINYINT},
      is_annotation = #{isAnnotation,jdbcType=TINYINT}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <select id="fuzzySelectPublicDlDatasetByName" parameterType="String" resultMap="BaseResultMap" useCache="false">
    select *
    from dl_dataset
    where type=0 and is_deleted=0
     <if test="datasetName!=null">and name like '%${datasetName}%'</if>
    order by create_time desc
  </select>

  <select id="fuzzySelectUserDlDatasetByName" resultMap="BaseResultMap" useCache="false">
    select *
    from dl_dataset
    where type=1 and is_deleted=0 and fk_user_id=#{userId}
    <if test="datasetName!=null">and name like '%${datasetName}%'</if>
    order by create_time desc
  </select>

  <select id="fuzzySelectPublicDlDatasetByTags" parameterType="String" resultMap="BaseResultMap" useCache="false">
    select *
    from dl_dataset
    where type=0 and is_deleted=0
    <if test="datasetTags!=null">and tags like '%${datasetTags}%'</if>
    order by create_time desc
  </select>

  <select id="fuzzySelectUserDlDatasetByTags" resultMap="BaseResultMap" useCache="false">
    select *
    from dl_dataset
    where type=1 and is_deleted=0 and fk_user_id=#{userId}
    <if test="datasetTags!=null">and tags like '%${datasetTags}%'</if>
    order by create_time desc
  </select>

  <select id="getPublicDldataset" resultMap="BaseResultMap">
            select *
            from dl_dataset
            where type=0 and is_deleted=0
    </select>

  <select id="getUserDldataset" parameterType="Integer" resultMap="BaseResultMap" useCache="false">
        select *
        from dl_dataset
        where type=1 and is_deleted=0 and fk_user_id=#{userId}
    </select>

  <update id="deleteDldatasetById" parameterType="Integer">
        update dl_dataset
        set is_deleted=1
        where id=#{datasetId}
    </update>

  <delete id="deleteDldatasetCompletelyById" parameterType="Integer">
        delete from dl_dataset
        where id=#{datasetId} and is_deleted=1
     </delete>

  <select id="getDldatasetInTrash" parameterType="Integer" resultMap="BaseResultMap">
        select *
        from dl_dataset
        where type=1 and is_deleted=1 and fk_user_id=#{userId}
    </select>

  <update id="restoreDldataset" parameterType="Integer">
        update dl_dataset
        set is_deleted=0
        where id=#{datasetId}
    </update>

</mapper>